<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <title>Flipbook PDF - M·∫Øt bi·∫øc</title>
</head>

<body>
  <div class="book-container">
    <!-- Flipbook -->
    <div id="flipbook" class="flipbook"></div>

    <!-- Thanh ƒëi·ªÅu khi·ªÉn -->
    <div class="book-controls">
      <span>Trang: <span id="current-page">1</span>/<span id="total-pages">0</span></span>

      <div class="goto-box">
        <input
          type="number"
          id="goto-page"
          min="1"
          placeholder="Nh·∫≠p s·ªë trang..."
        />
        <button id="btn-goto">T·ªõi trang</button>
      </div>
    </div>
  </div>

  <!-- jQuery v√† Turn.js (file b·∫°n ƒë√£ c√≥ s·∫µn) -->
  <!-- jQuery v√† Turn.js (file b·∫°n ƒë√£ c√≥ s·∫µn) -->
  <script src="jquery.js"></script>
  <script src="turn.js"></script>

  <!-- PDF.js t·ª´ CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // C·∫•u h√¨nh worker c·ªßa PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    // ƒê∆Ø·ªúNG D·∫™N FILE PDF C·ª¶A B·∫†N
    const pdfUrl = "sach-demo.pdf"; // üëâ ƒë·ªïi t√™n n·∫øu file PDF c·ªßa b·∫°n kh√°c t√™n

    const $flipbook = $("#flipbook");
    let pdfTotalPages = 0;

    // T√≠nh k√≠ch th∆∞·ªõc s√°ch theo m√†n h√¨nh (∆∞u ti√™n cho ƒëi·ªán tho·∫°i n·∫±m ngang)
    function getBookSize() {
      // T·ª∑ l·ªá g·ªëc c·ªßa s√°ch (2 trang): 1000 x 600
      const RATIO = 1000 / 600;

      // D√πng g·∫ßn nh∆∞ full m√†n h√¨nh
      let availW = window.innerWidth * 0.98;  // 98% chi·ªÅu r·ªông
      let availH = window.innerHeight * 0.9;  // 90% chi·ªÅu cao (ƒë·ªÉ ch·ª´a ch·ªó cho thanh ƒëi·ªÅu khi·ªÉn)

      // ∆Øu ti√™n d√πng h·∫øt chi·ªÅu r·ªông tr∆∞·ªõc
      let width = availW;
      let height = width / RATIO;

      // N·∫øu cao h∆°n chi·ªÅu cao cho ph√©p th√¨ thu b·ªõt l·∫°i theo chi·ªÅu cao
      if (height > availH) {
        height = availH;
        width = height * RATIO;
      }

      return {
        width: Math.round(width),
        height: Math.round(height),
      };
    }

    // C·∫≠p nh·∫≠t s·ªë trang ƒëang xem (t·ª´ page c·ªßa turn.js ‚Üí page PDF)
    function updateCurrentPage(turnPage) {
      if (!pdfTotalPages) return;

      // C·∫•u tr√∫c:
      // 1: b√¨a c·ª©ng
      // 2: m·∫∑t trong b√¨a
      // 3..(pdfTotalPages+2): trang PDF
      // ... cu·ªëi: b√¨a sau
      let pdfPage;
      if (turnPage <= 2) {
        pdfPage = 1;
      } else if (turnPage >= pdfTotalPages + 3) {
        pdfPage = pdfTotalPages;
      } else {
        pdfPage = turnPage - 2;
      }

      document.getElementById("current-page").textContent = pdfPage;
    }

    // Kh·ªüi t·∫°o flipbook
    function initFlipbook() {
      const size = getBookSize();

      if ($flipbook.data("initialized")) {
        // N·∫øu ƒë√£ init r·ªìi -> ch·ªâ resize l·∫°i
        $flipbook.turn("size", size.width, size.height);
        return;
      }

      $flipbook.turn({
        width: size.width,
        height: size.height,
        autoCenter: true,
        elevation: 50,
        gradients: true,
        display: "double",
        page: 3, // m·ªü ·ªü trang n·ªôi dung ƒë·∫ßu ti√™n
      });

      // Khi l·∫≠t trang xong
      $flipbook.bind("turned", function (e, page) {
        updateCurrentPage(page);
      });

      $flipbook.data("initialized", true);

      // L√∫c m·ªõi v√†o, c·∫≠p nh·∫≠t lu√¥n s·ªë trang (ƒëang ·ªü page 3)
      updateCurrentPage(3);

      // Resize khi xoay ngang/ƒë·ªïi k√≠ch th∆∞·ªõc m√†n h√¨nh
      window.addEventListener("resize", function () {
        if ($flipbook.data("initialized")) {
          const s = getBookSize();
          $flipbook.turn("size", s.width, s.height);
        }
      });
    }

    // T√≠nh nƒÉng "t·ªõi trang"
    function setupGoto() {
      const input = document.getElementById("goto-page");
      const btn = document.getElementById("btn-goto");

      function goToPage() {
        if (!pdfTotalPages || !$flipbook.data("initialized")) return;

        let val = parseInt(input.value, 10);
        if (isNaN(val)) return;

        if (val < 1) val = 1;
        if (val > pdfTotalPages) val = pdfTotalPages;

        // map: pdfPage -> turnPage
        const turnPage = val + 2;
        $flipbook.turn("page", turnPage);
      }

      btn.addEventListener("click", goToPage);
      input.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          goToPage();
        }
      });
    }

    setupGoto();

    // T·∫£i PDF
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    loadingTask.promise
      .then(function (pdf) {
        pdfTotalPages = pdf.numPages;
        document.getElementById("total-pages").textContent = pdfTotalPages;

        const totalPages = pdf.numPages;

        // B√¨a ƒë·∫ßu
        $flipbook.append(`
          <div class="hard">
            M·∫Øt bi·∫øc
            <small>Nguy·ªÖn Nh·∫≠t √Ånh</small>
          </div>
        `);
        // M·∫∑t trong b√¨a
        $flipbook.append(`<div class="hard"></div>`);

        // T·∫°o khung tr·ªëng cho m·ªói trang PDF
        const pageDivs = [];
        for (let i = 1; i <= totalPages; i++) {
          const pageDiv = document.createElement("div");
          pageDiv.classList.add("page");
          pageDiv.setAttribute("data-page", i);
          $flipbook.append(pageDiv);
          pageDivs[i] = pageDiv;
        }

        // B√¨a sau (th√™m lu√¥n, KH√îNG ch·ªù render)
        $flipbook.append(`<div class="hard"></div>`);
        $flipbook.append(`
          <div class="hard">
            H·∫øt s√°ch
            <small>~ Flipbook PDF</small>
          </div>
        `);

        // üëâ Kh·ªüi ƒë·ªông flipbook NGAY sau khi c√≥ ƒë·ªß khung trang
        initFlipbook();

        // Render t·ª´ng trang PDF (n·ªôi dung) ‚Äì KH√îNG ch·∫∑n init
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
          pdf.getPage(pageNum).then(function (page) {
            const scale = 1.5;
            const viewport = page.getViewport({ scale: scale });

            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            canvas.style.width = "100%";
            canvas.style.height = "auto";
            canvas.style.display = "block";

            const renderContext = {
              canvasContext: context,
              viewport: viewport,
            };

            page.render(renderContext).promise.then(function () {
              const container = pageDivs[page.pageNumber];
              if (container) {
                container.innerHTML = "";

                const inner = document.createElement("div");
                inner.classList.add("page-inner");
                inner.appendChild(canvas);

                container.appendChild(inner);
              }
            }).catch(function (err) {
              console.error("L·ªói render trang PDF:", page.pageNumber, err);
            });
          }).catch(function (err) {
            console.error("L·ªói l·∫•y trang PDF:", pageNum, err);
          });
        }
      })
      .catch(function (err) {
        console.error("L·ªói khi load PDF:", err);
        alert(
          "Kh√¥ng t·∫£i ƒë∆∞·ª£c file PDF. H√£y ki·ªÉm tra l·∫°i t√™n file v√† ƒë∆∞·ªùng d·∫´n (pdfUrl)."
        );
      });
  </script>

</body>

</html>


